<!DOCTYPE html>
<html lang="sv">
<meta name="viewport"
  content="width=device-width, initial-scale=1, viewport-fit=cover, shrink-to-fit=no">
<style>
  /* 1) Gör text och komponenter proportionerliga på surfplattor */
  :root{
    /* Bas i rem som följer minsta av bredd/höjd, men aldrig för liten/stor */
    font-size: clamp(14px, min(2.8vw, 3.2vh), 28px);
    --pad: max(0.5rem, 2svh);     /* ersätt 8px/2vh med rem/svh */
    --radius: 1.25rem;
    --touch: 3rem;                 /* ~48px touch-minimum, men responsivt */
  }

  /* 2) Hindra webkit/Android från att krympa text konstigt */
  html { -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }
  body {
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
    color:#fff;
    background:#000;
    /* 3) Använd nya viewport-enheter som funkar bättre med mobila adressfält */
    height: 100svh;          /* “small viewport height” */
    min-height: 100svh;
    overflow:hidden;
    transition: background .25s ease;
  }

  /* fallback för äldre webview om svh saknas */
  @supports not (height: 100svh) {
    body { height: 100vh; min-height: 100vh; }
  }

  /* Exempel: gör stora siffror som skalar snyggt på platta */
  .timer {
    font-variant-numeric: tabular-nums lining-nums;
    font-weight: 700;
    /* 4) Skala text efter bredd/höjd – blir stort på platta, inte pyttigt */
    font-size: clamp(2rem, 10vmin, 8rem);
    line-height: 1;
    letter-spacing: 0.04em;
  }

  /* Knappar/ytor får rimliga touch-mått */
  .btn {
    min-height: var(--touch);
    min-width: calc(var(--touch) * 2);
    padding: 0 1rem;
    border-radius: var(--radius);
  }

  /* Behåll dina färg- och statusklasser som tidigare */
  body.danger { background:#8b0000; }
</style>
<body>
  <div class="wrap">
    <div class="stage" id="stage">
      <div class="title" id="title">Tid kvar</div>
      <div class="time" id="time">--</div>

      <div class="bar" id="bar"><div class="fill" id="fill"></div></div>
      <div class="ticks" id="ticks"></div>

      <div class="footer">
        <div class="pills">
          <div class="pill" id="activePeriod">–</div>
          <div class="pill" id="nextPeriod">–</div>
        </div>
      </div>

      <div class="fab" id="openSettings" aria-label="Inställningar">⚙︎</div>

      <div class="settings" id="settings">
        <h2>Perioder</h2>
        <p>Lägg till tidsperioder för dygnet. Timern väljer automatiskt den period som matchar klockslaget och räknar ner till periodens slut.</p>
        <div id="rows"></div>
        <div class="actions">
          <button id="add">+ Lägg till period</button>
          <button id="save">Spara</button>
          <button id="close">Stäng</button>
        </div>
        <p><small>Tips: Kör i helskärm. Allt sparas lokalt i webbläsaren.</small></p>
      </div>
    </div>
  </div>

<script>
(function(){
  var $ = function(s){ return document.querySelector(s); };
  var title=$('#title'), timeEl=$('#time'), fill=$('#fill'), ticks=$('#ticks');
  var active=$('#activePeriod'), nextP=$('#nextPeriod'), settings=$('#settings');

  var DEFAULT_PERIODS = [
    { name:"Morgon",     start:"07:00", end:"09:00" },
    { name:"Arbetstid",  start:"09:00", end:"17:00" },
    { name:"Kväll",      start:"17:00", end:"22:30" },
    { name:"Läggdags",   start:"22:30", end:"24:00" },
    { name:"Natt",       start:"00:00", end:"07:00" }
  ];

  function getPeriods(){
    try{
      var r=localStorage.getItem('walltimer.periods');
      var arr=r?JSON.parse(r):DEFAULT_PERIODS;
      if (Object.prototype.toString.call(arr)==='[object Array]' && arr.length){ return arr; }
      return DEFAULT_PERIODS;
    }catch(e){ return DEFAULT_PERIODS; }
  }
  function setPeriods(p){ localStorage.setItem('walltimer.periods', JSON.stringify(p)); }

  function t2m(t){ var parts=t.split(':'), h=parseInt(parts[0],10)||0, m=parseInt(parts[1],10)||0; return (h%24)*60+m; }
  function nowMin(){ var n=new Date(); return n.getHours()*60+n.getMinutes()+n.getSeconds()/60; }
  function z2(n){ n=String(n); return n.length<2 ? ('0'+n) : n; }
  function fmt(ms){
    var s=Math.max(0, Math.floor(ms/1000));
    var h=Math.floor(s/3600); s-=h*3600;
    var m=Math.floor(s/60); s-=m*60;
    return h+'h '+m+'m '+z2(s)+'s';
  }

  function expand(ps){
    var out=[], i, p, a, b;
    for(i=0;i<ps.length;i++){
      p=ps[i]; a=t2m(p.start); b=t2m(p.end);
      if(b>=a){ out.push({name:p.name,start:p.start,end:p.end,a:a,b:b}); }
      else { out.push({name:p.name,start:p.start,end:p.end,a:a,b:1440}); out.push({name:p.name,start:p.start,end:p.end,a:0,b:b}); }
    }
    out.sort(function(x,y){ return x.a-y.a; });
    return out;
  }

  function pick(ps){
    var n=nowMin(), list=expand(ps);
    var i, cur=null, nxt=null;
    for(i=0;i<list.length;i++){
      var p=list[i];
      if(n>=p.a && n<p.b){ cur=p; nxt=list[(i+1)%list.length]; break; }
    }
    if(!cur){
      for(i=0;i<list.length;i++){ if(list[i].a>n){ nxt=list[i]; break; } }
      if(!nxt) nxt=list[0];
      cur = { name:"Paus", a:n, b:nxt.a };
    }
    return {cur:cur, nxt:nxt};
  }

  function chooseTickStep(totalMin){
    if (totalMin <= 120) return 30;
    if (totalMin <= 480) return 60;
    return 120;
  }
  function fmtTick(mins){
    if (mins % 60 === 0) return (mins/60)+'h';
    return (mins%60)+'m';
  }
  function drawTicks(totalMin){
    ticks.innerHTML='';
    var step = chooseTickStep(totalMin);
    for(var at=0; at<=totalMin; at+=step){
      var left = (at/totalMin)*100;
      var div = document.createElement('div');
      div.className='tick';
      div.style.left = left+'%';
      div.innerHTML = '<i></i><span>'+fmtTick(at)+'</span>';
      ticks.appendChild(div);
    }
    var end = document.createElement('div');
    end.className = 'tick end';
    end.style.left = '100%';
    end.innerHTML = '<i></i><span>slut</span>';
    ticks.appendChild(end);
  }

  var audioCtx;
  function beep(ms,freq){
    ms = ms || 200; freq = freq || 880;
    try{
      audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
      var o=audioCtx.createOscillator(), g=audioCtx.createGain();
      o.connect(g); g.connect(audioCtx.destination);
      o.type='sine'; o.frequency.value=freq; g.gain.value=.05; o.start();
      setTimeout(function(){ try{o.stop();}catch(e){} }, ms);
    }catch(e){}
  }

  function loop(){
    var ps=getPeriods();
    var pickRes=pick(ps); var cur=pickRes.cur, nxt=pickRes.nxt;

    var n = new Date();
    var nMin = n.getHours()*60 + n.getMinutes() + n.getSeconds()/60;
    var total = (cur.b - cur.a) * 60 * 1000;
    var passed = (nMin - cur.a) * 60 * 1000;
    var remain = Math.max(0, total - passed);

    var endMin = cur.b % 1440;
    var endH = z2(Math.floor(endMin/60));
    var endM = z2(endMin%60);

    title.textContent = 'Tid kvar till ' + nxt.name + ' (kl ' + endH + ':' + endM + ')';

    timeEl.textContent = fmt(remain);
    var pct = total>0 ? Math.min(100, Math.max(0, (passed/total)*100)) : 100;
    fill.style.width = pct + '%';

    drawTicks((cur.b - cur.a));

    active.textContent = 'Nu: ' + cur.name;
    nextP.textContent  = 'Nästa: ' + nxt.name + ' → ' + z2(Math.floor(nxt.a/60)) + ':' + z2(nxt.a%60);

    if (remain <= 10 * 60 * 1000) { document.body.className = (document.body.className+' danger').trim(); }
    else { document.body.className = document.body.className.replace(/\bdanger\b/g,'').trim(); }

    if(remain<=1000 && remain>0){
      for(var i=0;i<5;i++){
        (function(ii){
          setTimeout(function(){ beep(120, 1000+ii*60); }, ii*180);
        })(i);
      }
    }

    window.requestAnimationFrame(loop);
  }

  function openSettings(v){ settings.style.display = v? 'block':'none'; }
  function rowTpl(p,i){
    return '<div class="row" data-i="'+i+'">'
         + '<input type="text" value="'+(p.name||'')+'" aria-label="Namn" placeholder="Namn (t.ex. Läggdags)" />'
         + '<input type="time" value="'+(p.start||'00:00')+'" aria-label="Start" />'
         + '<input type="time" value="'+(p.end||'00:00')+'" aria-label="Slut" />'
         + '<button data-del="'+i+'">Ta bort</button>'
         + '</div>';
  }
  function renderRows(){
    var rows=$('#rows'); var ps=getPeriods();
    var html='', i; for(i=0;i<ps.length;i++){ html+=rowTpl(ps[i], i); }
    rows.innerHTML = html;
  }
  function saveRows(){
    var nodes=document.querySelectorAll('.row'); var i, arr=[];
    for(i=0;i<nodes.length;i++){
      var r=nodes[i];
      var inputs=r.querySelectorAll('input');
      var name=inputs[0].value, start=inputs[1].value, end=inputs[2].value;
      arr.push({ name: name||'Period', start: start, end: end });
    }
    setPeriods(arr); renderRows(); openSettings(false);
  }

  $('#openSettings').addEventListener('click', function(){ renderRows(); openSettings(true); });
  var touchTimer=null;
  document.addEventListener('touchstart', function(){ touchTimer=setTimeout(function(){ renderRows(); openSettings(true); }, 650); }, {passive:true});
  document.addEventListener('touchend', function(){ if(touchTimer){ clearTimeout(touchTimer); touchTimer=null; }}, {passive:true});

  $('#close').addEventListener('click', function(){ openSettings(false); });
  $('#save').addEventListener('click', saveRows);
  $('#add').addEventListener('click', function(){
    var ps=getPeriods(); ps.push({name:"Ny period", start:"12:00", end:"13:00"}); setPeriods(ps); renderRows();
  });
  settings.addEventListener('click', function(e){
    var t=e.target; while(t && t!==settings && !(t.getAttribute && t.getAttribute('data-del'))){ t=t.parentNode; }
    if(t && t.getAttribute && t.getAttribute('data-del')){
      var i=parseInt(t.getAttribute('data-del'),10);
      var ps=getPeriods(); ps.splice(i,1); setPeriods(ps); renderRows();
    }
  });

  document.addEventListener('dblclick', function(){
    var el=document.documentElement; if(el.requestFullscreen) el.requestFullscreen();
  });

  loop();
})();
</script>
</body>
</html>
