<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>Väggtimer – färgdynamisk version</title>
<style>
  :root{
    --fs-time: 220px;
    --fs-title: 3rem;
    --fs-subtitle: 1.4rem;

    --bar-h: 56px;
    --bar-radius: 16px;

    --bar-bg: #2a2a2a;
    --bar-fill: #FF8811;
  }

  html,body{
    height:100%; margin:0;
    background:#000;
    color:#fff; overflow:hidden;
    -webkit-text-size-adjust:100%; text-size-adjust:100%;
    transition:background 0.6s ease;
  }

  body.danger{
    background:#226EB1;
  }

  #stage{
    position:absolute; left:0; top:0;
    width:1280px; height:800px;
    box-sizing:border-box;
    padding:20px;
    display:grid;
    grid-template-rows:auto auto 1fr auto;
    gap:12px;
    transform-origin:0 0; will-change:transform;
    background:transparent;
  }

  .title{
    text-align:center; font-weight:800; letter-spacing:.3px; opacity:.98;
    font-size: var(--fs-title);
  }
  .subtitle{
    text-align:center; font-weight:700; opacity:.95;
    font-size: var(--fs-subtitle);
  }
  .time{
    display:grid; place-items:center;
    text-align:center; font-weight:900; line-height:1;
    letter-spacing:.4px; font-size: var(--fs-time);
    white-space:nowrap; margin-bottom:8px;
  }

  .track{
    position:relative;
    margin: 0 auto;
    padding: 0;
    width: 900px;
    transition: background 0.6s ease;
  }

  .bar{
    position:relative;
    height: var(--bar-h);
    background: var(--bar-bg);
    border-radius: var(--bar-radius);
    overflow:hidden;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
    transition: background 0.6s ease;
  }

  .fill{
    position:absolute;
    left:0; top:0; bottom:0;
    height:100%;
    width:0%;
    background: var(--bar-fill);
    border-radius: inherit;
    transform: translateZ(0);
  }

  .ticks{ position:relative; height: 52px; }
  .tick{ position:absolute; top:0; transform:translateX(-50%); text-align:center; }
  .tick i{ display:block; width:3px; height:24px; background:rgba(255,255,255,.95);
           margin:0 auto 6px; border-radius:2px; }
  .tick span{ font-size:1.15rem; opacity:.98; font-weight:700; }
  .tick.end i{ width:4px; height:28px; background:#fff; }
  .tick.end span{ font-weight:900; }

  .fab{
    position:absolute; right:16px; top:16px;
    width:64px; height:64px; z-index:10;
    border-radius:999px; display:grid; place-items:center;
    background:#151515; color:#fff; border:1px solid #2a2a2a;
    font-size:20px; user-select:none; cursor:pointer; touch-action:manipulation;
    box-shadow: 0 8px 24px rgba(0,0,0,.4);
  }

  .settings{
    position:absolute; inset:0; background:rgba(0,0,0,.94);
    border:none; padding:20px; display:none; overflow:auto; z-index:20;
  }
  .settings h2{margin:.2em 0 .6em; font-size:1.375rem;}
  .row{display:grid; grid-template-columns:1.2fr 1fr 1fr auto; gap:10px; align-items:center; margin:.5em 0;}
  .row input{ padding:.8em .9em; border-radius:12px; border:1px solid #2a2a2a; background:#0d0d0d; color:#fff; font-size:1rem;}
  .settings .actions{display:flex; gap:12px; margin-top:10px; flex-wrap:wrap;}
  .settings button{ padding:.9em 1.1em; min-height:48px; border-radius:12px; border:1px solid #2a2a2a; background:#101010; color:#fff; font-weight:700; cursor:pointer; font-size:1rem;}
</style>
</head>
<body>
  <div id="stage">
    <div class="title" id="title">Tid kvar</div>
    <div class="subtitle" id="subtitle">–</div>

    <div class="time" id="time">--</div>

    <div class="track" id="track">
      <div class="bar" id="bar"><div class="fill" id="fill"></div></div>
      <div class="ticks" id="ticks"></div>
    </div>

    <div class="fab" id="openSettings" aria-label="Inställningar">⚙︎</div>

    <div class="settings" id="settings">
      <h2>Perioder</h2>
      <p>Lägg till tidsperioder för dygnet. Timern väljer automatiskt den period som matchar klockslaget och räknar ner till periodens slut.</p>
      <div id="rows"></div>
      <div class="actions">
        <button id="add">+ Lägg till period</button>
        <button id="save">Spara</button>
        <button id="close">Stäng</button>
      </div>
    </div>
  </div>

<script>
var $ = s => document.querySelector(s);
var title=$('#title'), subtitle=$('#subtitle'), timeEl=$('#time'), fill=$('#fill'), ticks=$('#ticks');
var bar=$('#bar'), track=$('#track');

var DEFAULT_PERIODS=[
  {name:"Morgon",start:"07:00",end:"09:00"},
  {name:"Arbetstid",start:"09:00",end:"17:00"},
  {name:"Kväll",start:"17:00",end:"22:30"},
  {name:"Läggdags",start:"22:30",end:"23:59"},
  {name:"Natt",start:"00:00",end:"07:00"}
];
function getPeriods(){
  try{let r=localStorage.getItem('walltimer.periods');
    let arr=r?JSON.parse(r):DEFAULT_PERIODS;
    return Array.isArray(arr)&&arr.length?arr:DEFAULT_PERIODS;
  }catch(e){return DEFAULT_PERIODS;}
}
function setPeriods(p){localStorage.setItem('walltimer.periods',JSON.stringify(p));}
function t2m(t){let [h,m]=t.split(':').map(Number);return (h%24)*60+(m||0);}
function nowMin(){let n=new Date();return n.getHours()*60+n.getMinutes()+n.getSeconds()/60;}
function pad2(x){return(x<10?'0':'')+x;}
function fmt(ms){let s=Math.max(0,Math.floor(ms/1000));let h=Math.floor(s/3600);s-=h*3600;let m=Math.floor(s/60);s-=m*60;return h+'h '+m+'m '+pad2(s)+'s';}
function expand(ps){let out=[];for(let p of ps){let a=t2m(p.start),b=t2m(p.end);if(b>=a)out.push({...p,a,b});else{out.push({...p,a,b:1440});out.push({...p,a:0,b});}}out.sort((x,y)=>x.a-y.a);return out;}
function pick(ps){let n=nowMin(),list=expand(ps),cur=null,nxt=null;for(let i=0;i<list.length;i++){let p=list[i];if(n>=p.a&&n<p.b){cur=p;nxt=list[(i+1)%list.length];break;}}if(!cur){nxt=list.find(p=>p.a>n)||list[0];cur={name:"Paus",a:n,b:nxt.a};}return{cur,nxt};}

function drawTicks(totalMin){
  ticks.innerHTML='';
  let step=totalMin<=120?30:totalMin<=480?60:120;
  for(let at=0;at<totalMin;at+=step){
    let left=(at/totalMin)*100;
    let div=document.createElement('div');
    div.className='tick';
    div.style.left=left+'%';
    div.innerHTML='<i></i><span>'+((at%60===0)?(at/60)+'h':(at%60)+'m')+'</span>';
    ticks.appendChild(div);
  }
  let end=document.createElement('div');
  end.className='tick end';end.style.left='100%';
  end.innerHTML='<i></i><span>slut</span>';ticks.appendChild(end);
}

function mixColor(c1,c2,f){
  function hexToRgb(h){let n=parseInt(h.slice(1),16);return[(n>>16)&255,(n>>8)&255,n&255];}
  function rgbToHex(r,g,b){return"#"+[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('');}
  let a=hexToRgb(c1),b=hexToRgb(c2);
  let m=a.map((x,i)=>Math.round(x*(1-f)+b[i]*f));
  return rgbToHex(...m);
}

function updateBarBackground(){
  let bg=getComputedStyle(document.body).backgroundColor;
  let tmp=document.createElement('div');
  tmp.style.color=bg;document.body.appendChild(tmp);
  let rgb=window.getComputedStyle(tmp).color;document.body.removeChild(tmp);
  let match=rgb.match(/\d+/g);
  let bgHex=match?"#"+match.map(x=>(+x).toString(16).padStart(2,'0')).join(''):"#000000";
  let fillColor=getComputedStyle(fill).backgroundColor;
  tmp.style.color=fillColor;document.body.appendChild(tmp);
  rgb=window.getComputedStyle(tmp).color;document.body.removeChild(tmp);
  match=rgb.match(/\d+/g);
  let fillHex=match?"#"+match.map(x=>(+x).toString(16).padStart(2,'0')).join(''):"#ffffff";
  track.style.background=mixColor(bgHex,fillHex,0.25);
  bar.style.background=mixColor(bgHex,fillHex,0.35);
}

function loop(){
  let ps=getPeriods();
  let {cur,nxt}=pick(ps);
  let n=new Date();
  let nMin=n.getHours()*60+n.getMinutes()+n.getSeconds()/60;
  let total=(cur.b-cur.a)*60000;
  let passed=(nMin-cur.a)*60000;
  let remain=Math.max(0,total-passed);

  title.textContent='Tid kvar till '+nxt.name;
  subtitle.textContent='Nästa: '+nxt.name;

  timeEl.textContent=fmt(remain);

  let pct=total>0?Math.min(100,Math.max(0,(passed/total)*100)):100;
  fill.style.width=pct+'%';

  drawTicks(cur.b-cur.a);

  if(remain<=10*60*1000)document.body.classList.add('danger');
  else document.body.classList.remove('danger');

  updateBarBackground();

  requestAnimationFrame(loop);
}
window.addEventListener('load',()=>requestAnimationFrame(loop));
</script>
</body>
</html>
