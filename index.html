<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>Väggtimer – helskärm med mittklocka (Fire-kompatibel)</title>
<style>
  :root{
    /* Typsnittsstorlekar */
    --fs-time: 240px;   /* STOR klocka i mitten */
    --fs-title: 36px;   /* Info nere till höger */
    --fs-subtitle: 28px;

    /* Färger */
    --meter-bg: #226EB1;   /* ofylld del (hela bakgrunden) */
    --meter-fill: #FF8811; /* fylld del */

    /* UI */
    --pad: 16px;
    --tick-w: 4px;
  }

  html,body{
    height:100%; margin:0;
    background:#000; color:#fff; overflow:hidden;
    -webkit-text-size-adjust:100%; text-size-adjust:100%;
  }

  /* HELA skärmen = mätaren */
  #meter{
    position:fixed; left:0; top:0; right:0; bottom:0;  /* istället för inset:0 */
    background: var(--meter-bg);
    -webkit-tap-highlight-color: transparent;
  }
  /* Fyllda delen (räknar upp i bredd) */
  #fill{
    position:absolute; left:0; top:0; bottom:0; width:0%;
    background: var(--meter-fill);
    transform: translateZ(0);
    z-index: 1;
  }

  /* Vertikala tidsstreck över hela höjden */
  #ticks{
    position:absolute; left:0; top:0; right:0; bottom:0; /* istället för inset */
    pointer-events:none;
    z-index: 5; /* ovanpå fyllnaden */
  }
  .tick{
    position:absolute; top:0; bottom:0; width: var(--tick-w);
    margin-left: calc(var(--tick-w) * -0.5);
    background: rgba(255,255,255,0.95);
    border-radius:2px;
  }
  .tick.end{ width:6px; background:#fff; }
  .tick-label{
    position:absolute; bottom: calc(var(--pad) + 8px);
    right: -8px;
    font-size: 22px; font-weight: 900; white-space:nowrap;
    text-shadow: 0 2px 4px rgba(0,0,0,.6);
  }

  /* STOR NEDRÄKNARE I MITTEN */
  #centerTime{
    position:absolute; left:50%; top:50%;
    transform: translate(-50%,-50%);
    z-index: 10; text-align:center;
    text-shadow: 0 3px 10px rgba(0,0,0,.5);
  }
  #time{
    font-size: var(--fs-time); font-weight:900; letter-spacing:.4px; line-height:1;
    white-space:nowrap;
  }

  /* NEDRE HÖGER: “Tid kvar” + “Nästa” */
  #bottomRight{
    position:absolute; right: var(--pad); bottom: var(--pad);
    text-align:right; z-index:10; line-height:1.15; max-width: 90%;
    text-shadow: 0 2px 6px rgba(0,0,0,.45);
  }
  #title{
    font-size: var(--fs-title); font-weight:900; letter-spacing:.3px;
  }
  #subtitle{
    font-size: var(--fs-subtitle); font-weight:800; opacity:.98; margin-top:6px;
  }

  /* Liten FAB för inställningar */
  .fab{
    position:absolute; left: var(--pad); top: var(--pad);
    width:56px; height:56px; z-index:12;
    border-radius:999px; display:grid; place-items:center;
    background: rgba(0,0,0,.35); color:#fff; border:1px solid rgba(255,255,255,.15);
    font-size:20px; user-select:none; cursor:pointer; touch-action:manipulation;
    box-shadow: 0 8px 24px rgba(0,0,0,.35);
  }

  /* Inställningsruta (utan inset) */
  .settings{
    position:absolute; left:0; top:0; right:0; bottom:0;
    background:rgba(0,0,0,.92);
    border:none; padding:20px; display:none; overflow:auto; z-index:20;
  }
  .settings h2{margin:.2em 0 .6em; font-size:1.3rem;}
  .row{display:block; margin:.5em 0;}
  .row input{
    width: 31%; min-width: 180px; margin-right:8px;
    padding:.8em .9em; border-radius:12px; border:1px solid #2a2a2a;
    background:#0d0d0d; color:#fff; font-size:1rem;
  }
  .settings .actions{display:flex; gap:12px; margin-top:10px; flex-wrap:wrap;}
  .settings button{
    padding:.9em 1.1em; min-height:48px; border-radius:12px;
    border:1px solid #2a2a2a; background:#101010; color:#fff;
    font-weight:700; cursor:pointer; font-size:1rem;
  }
</style>
</head>
<body>
  <div id="meter">
    <div id="fill"></div>
    <div id="ticks"></div>

    <!-- Stor klocka i mitten -->
    <div id="centerTime"><div id="time">--</div></div>

    <!-- Info nere till höger -->
    <div id="bottomRight">
      <div id="title">Tid kvar</div>
      <div id="subtitle">–</div>
    </div>

    <div class="fab" id="openSettings" aria-label="Inställningar">⚙︎</div>
    <div class="settings" id="settings">
      <h2>Perioder</h2>
      <p>Lägg till tidsperioder för dygnet. Timern väljer automatiskt den period som matchar klockslaget och räknar ner till periodens slut.</p>
      <div id="rows"></div>
      <div class="actions">
        <button id="add">+ Lägg till period</button>
        <button id="save">Spara</button>
        <button id="close">Stäng</button>
      </div>
      <p><small>Tips: Kör i helskärm. Allt sparas lokalt i webbläsaren.</small></p>
    </div>
  </div>

<script>
/* --- Selektorer --- */
var $ = function(s){ return document.querySelector(s); };
var title=$('#title'), subtitle=$('#subtitle'), timeEl=$('#time');
var fill=$('#fill'), ticks=$('#ticks');
var settings=$('#settings');

/* --- Perioddata --- */
var DEFAULT_PERIODS = [
  { name:"Morgon",     start:"07:00", end:"09:00" },
  { name:"Arbetstid",  start:"09:00", end:"17:00" },
  { name:"Kväll",      start:"17:00", end:"22:30" },
  { name:"Läggdags",   start:"22:30", end:"23:59" },
  { name:"Natt",       start:"00:00", end:"07:00" }
];
function getPeriods(){
  try{
    var r=localStorage.getItem('walltimer.periods');
    var arr=r?JSON.parse(r):DEFAULT_PERIODS;
    return (Object.prototype.toString.call(arr)==='[object Array]' && arr.length)?arr:DEFAULT_PERIODS;
  }catch(e){ return DEFAULT_PERIODS; }
}
function setPeriods(p){ localStorage.setItem('walltimer.periods', JSON.stringify(p)); }

/* --- Hjälp --- */
function t2m(t){ var parts=t.split(':'), h=+parts[0], m=+parts[1]||0; return (h%24)*60+m; }
function nowMin(){ var n=new Date(); return n.getHours()*60+n.getMinutes()+n.getSeconds()/60; }
function pad2(x){ return (x<10?'0':'')+x; }
function fmt(ms){
  var s=Math.max(0, Math.floor(ms/1000));
  var h=Math.floor(s/3600); s-=h*3600;
  var m=Math.floor(s/60); s-=m*60;
  return h+'h '+m+'m '+pad2(s)+'s';
}

/* --- Splitta över midnatt & välj period (WebView 59-vänligt) --- */
function expand(ps){
  var out=[];
  for(var i=0;i<ps.length;i++){
    var p=ps[i], a=t2m(p.start), b=t2m(p.end);
    if(b>=a){
      out.push(Object.assign({}, p, {a:a, b:b}));
    }else{
      out.push(Object.assign({}, p, {a:a, b:1440}));
      out.push(Object.assign({}, p, {a:0,  b:b}));
    }
  }
  out.sort(function(x,y){ return x.a - y.a; });
  return out;
}
function pick(ps){
  var n=nowMin(), list=expand(ps);
  var cur=null, nxt=null;
  for(var i=0;i<list.length;i++){
    var p=list[i];
    if(n>=p.a && n<p.b){ cur=p; nxt=list[(i+1)%list.length]; break; }
  }
  if(!cur){
    nxt = (function(){
      for(var j=0;j<list.length;j++){ if(list[j].a>n) return list[j]; }
      return list[0];
    })();
    cur = { name:"Paus", a:n, b:nxt.a };
  }
  return {cur:cur, nxt:nxt};
}

/* --- Tidsstreck --- */
var __lastTotalMin = -1;
function chooseTickStep(totalMin){
  if (totalMin <= 120) return 30;   /* var 30:e minut upp till 2h */
  if (totalMin <= 480) return 60;   /* var timme upp till 8h */
  return 120;                       /* därefter varannan timme */
}
function fmtTick(mins){
  if (mins % 60 === 0) return (mins/60)+'h';
  return (mins%60)+'m';
}
function clearTicks(){ ticks.innerHTML=''; }
function drawTicks(totalMin){
  if (totalMin === __lastTotalMin) return; /* rita bara om när periodlängden ändras */
  __lastTotalMin = totalMin;
  clearTicks();
  var step = chooseTickStep(totalMin);
  for(var at=0; at<totalMin; at+=step){
    var pct = (at/totalMin)*100;
    var t = document.createElement('div');
    t.className = 'tick';
    t.style.left = pct + '%';
    var lab = document.createElement('div');
    lab.className = 'tick-label';
    lab.textContent = fmtTick(at);
    t.appendChild(lab);
    ticks.appendChild(t);
  }
  var end = document.createElement('div');
  end.className = 'tick end';
  end.style.left = '100%';
  var labEnd = document.createElement('div');
  labEnd.className = 'tick-label';
  labEnd.textContent = 'slut';
  end.appendChild(labEnd);
  ticks.appendChild(end);
}

/* --- Ljudpip vid slut --- */
var audioCtx;
function beep(ms, freq){
  ms = ms || 200; freq = freq || 880;
  try{
    audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
    var o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    o.type='sine'; o.frequency.value=freq; g.gain.value=.05; o.start();
    setTimeout(function(){ o.stop(); }, ms);
  }catch(e){}
}

/* --- Huvudloop --- */
function pad2n(n){ return (n<10?'0':'')+n; }
function loop(){
  var ps=getPeriods();
  var picked = pick(ps);
  var cur=picked.cur, nxt=picked.nxt;

  var n = new Date();
  var nMin = n.getHours()*60 + n.getMinutes() + n.getSeconds()/60;
  var total = (cur.b - cur.a) * 60 * 1000;
  var passed = (nMin - cur.a) * 60 * 1000;
  var remain = Math.max(0, total - passed);

  var endMin = cur.b % 1440;
  var endH = pad2n(Math.floor(endMin/60));
  var endM = pad2n(endMin%60);

  /* UI-texter */
  title.textContent = 'Tid kvar till ' + nxt.name + ' (kl ' + endH + ':' + endM + ')';
  subtitle.textContent = 'Nästa: ' + nxt.name + ' \u2192 ' +
    pad2n(Math.floor(nxt.a/60)) + ':' + pad2n(nxt.a%60);
  timeEl.textContent = fmt(remain);

  /* Fyllnadsgrad (räknar upp) */
  var pct = total>0 ? Math.min(100, Math.max(0, (passed/total)*100)) : 100;
  fill.style.width = pct + '%';

  /* Rita/uppdatera ticks när periodlängd ändras */
  drawTicks((cur.b - cur.a));

  /* Pipljud när den går i mål */
  if(remain<=1000 && remain>0){
    for(var i=0;i<5;i++){
      (function(k){ setTimeout(function(){ beep(120, 1000+k*60); }, k*180); })(i);
    }
  }

  requestAnimationFrame(loop);
}

/* --- Inställnings-UI --- */
function openSettings(v){ settings.style.display = (v===false)? 'none':'block'; }
function rowTpl(p,i){
  /* Fix: inget p[end] – enkel och kompatibel rad */
  return '<div class="row" data-i="'+i+'">'+
    '<input type="text" value="'+p.name+'" aria-label="Namn" placeholder="Namn (t.ex. Läggdags)" />'+
    '<input type="time" value="'+p.start+'" aria-label="Start" />'+
    '<input type="time" value="'+p.end+'" aria-label="Slut" />'+
    '<button data-del="'+i+'">Ta bort</button>'+
  '</div>';
}
function renderRows(){
  var rows=$('#rows'); var ps=getPeriods();
  var html=''; for(var i=0;i<ps.length;i++){ html+=rowTpl(ps[i],i); }
  rows.innerHTML = html;
}
function saveRows(){
  var rowEls=[].slice.call(document.querySelectorAll('.row'));
  var arr = rowEls.map(function(r){
    var ins=[].slice.call(r.querySelectorAll('input'));
    var name=ins[0].value, start=ins[1].value, end=ins[2].value;
    return { name: name||'Period', start: start, end: end };
  });
  setPeriods(arr); renderRows(); openSettings(false);
}

document.getElementById('openSettings').addEventListener('click', function(){ renderRows(); openSettings(true); });
var touchTimer=null;
document.addEventListener('touchstart', function(){
  touchTimer=setTimeout(function(){ renderRows(); openSettings(true); }, 650);
}, {passive:true});
document.addEventListener('touchend', function(){
  if(touchTimer){ clearTimeout(touchTimer); touchTimer=null; }
}, {passive:true});
document.getElementById('close').addEventListener('click', function(){ openSettings(false); });
document.getElementById('save').addEventListener('click', saveRows);
document.getElementById('add').addEventListener('click', function(){
  var ps=getPeriods(); ps.push({name:"Ny period", start:"12:00", end:"13:00"}); setPeriods(ps); renderRows();
});
settings.addEventListener('click', function(e){
  var el=e.target; if(!el || !el.getAttribute) return;
  var idx=el.getAttribute('data-del'); if(idx==null) return;
  var ps=getPeriods(); ps.splice(+idx,1); setPeriods(ps); renderRows();
});

/* Dubbeltapp för helskärm (om stöds) */
document.addEventListener('dblclick', function(){
  var el=document.documentElement; if(el.requestFullscreen) el.requestFullscreen();
});

/* --- Start --- */
loop(); /* Absolutpositionerat – ingen skalning behövs */
</script>
</body>
</html>
