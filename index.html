<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>Väggtimer – modern look</title>
<style>
  /* ========== Design-tokens (enkla, webview-vänliga) ========== */
  :root{
    /* Typografi */
    --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;

    --fs-time: clamp(120px, 17vw, 220px);
    --fs-title: clamp(1.4rem, 2.6vw, 3rem);
    --fs-subtitle: clamp(1.05rem, 1.6vw, 1.4rem);

    /* Färger */
    --bg-0: #0b1220;    /* mörk marin */
    --bg-1: #0e172a;    /* något ljusare marin */
    --acc-1: #FF8811;   /* barens fyllnad (orange) */
    --acc-2: #8ab6ff;   /* sekundär accent för text/glow */
    --danger: #A5402D;  /* bakgrund varning */

    /* Ytor & bar */
    --bar-h: 64px;
    --bar-radius: 16px;
    --bar-bg: rgba(255,255,255,0.07);
    --bar-fill: var(--acc-1);

    /* Linjer / skuggor */
    --line: rgba(255,255,255,.08);
    --line-strong: rgba(255,255,255,.12);
    --glow: 0 8px 24px rgba(0,0,0,.35);

    /* Touch & spacing */
    --pad: 20px;
    --touch: 52px;

    /* Ticks */
    --tick-line: rgba(255,255,255,.85);
    --tick-text: rgba(255,255,255,.92);
  }

  /* ========== Bas ========== */
  html,body{
    height:100%; margin:0; color:#eef2ff;
    font-family: var(--font);
    -webkit-text-size-adjust:100%; text-size-adjust:100%;
    background:
      radial-gradient(1200px 800px at 70% -10%, #1b2a4a 0%, transparent 60%),
      radial-gradient(1200px 800px at -10% 80%, #182647 0%, transparent 55%),
      linear-gradient(180deg, var(--bg-0), var(--bg-1) 65%, #0a1326 100%);
    overflow:hidden;
  }
  body.danger{
    background:
      radial-gradient(1200px 800px at 70% -10%, #c45a4a 0%, transparent 60%),
      radial-gradient(1200px 800px at -10% 80%, #8a3a2f 0%, transparent 55%),
      linear-gradient(180deg, #2a0e0a, var(--danger) 60%, #35110d 100%);
  }

  /* ========== Scen (1280×800 som skalas) ========== */
  #stage{
    position:absolute; inset:auto;
    left:0; top:0; width:1280px; height:800px;
    box-sizing:border-box; padding:var(--pad);
    display:grid; grid-template-rows:auto auto 1fr auto; gap:16px;
    transform-origin:0 0; will-change:transform; backface-visibility:hidden;
  }

  /* ========== Typografi ========== */
  .title{
    text-align:center; font-weight:800; letter-spacing:.3px; opacity:.98;
    font-size:var(--fs-title);
    text-shadow: 0 2px 12px rgba(0,0,0,.35);
  }
  .subtitle{
    text-align:center; font-weight:700; opacity:.92; font-size:var(--fs-subtitle);
    color:#dfe8ff;
  }
  .time{
    display:grid; place-items:center; text-align:center; font-weight:900;
    line-height:1; letter-spacing:.4px; font-size:var(--fs-time);
    white-space:nowrap; margin-bottom:6px;
    color:#ffffff;
    text-shadow:
      0 12px 30px rgba(0,0,0,.5),
      0 0 20px rgba(138,182,255,.08);
  }

  /* ========== Progressbar & ticks ========== */
  .track{ position:relative; margin:0 auto; padding:0; width:900px; }
  .bar{
    position:relative; height:var(--bar-h);
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
    border-radius:var(--bar-radius); overflow:hidden;
    box-shadow: inset 0 0 0 1px var(--line-strong), var(--glow);
  }
  .fill{
    position:absolute; left:0; top:0; bottom:0; height:100%; width:0%;
    background:
      linear-gradient(180deg, rgba(255,255,255,.25), rgba(255,255,255,0) 60%),
      linear-gradient(90deg, rgba(255,255,255,.08), rgba(255,255,255,0) 40%),
      linear-gradient(180deg, #ffb15e, var(--bar-fill) 35%, #e06f00 100%);
    border-radius:inherit; transform:translateZ(0);
  }

  .ticks{ position:relative; height:60px; }
  .tick{
    position:absolute; top:0; transform:translateX(-50%); text-align:center;
    color:var(--tick-text);
  }
  .tick i{
    display:block; width:2px; height:28px; background:var(--tick-line);
    margin:0 auto 8px; border-radius:2px;
    box-shadow: 0 6px 12px rgba(0,0,0,.25);
  }
  .tick span{
    display:inline-block; padding:.18rem .5rem; border-radius:999px;
    font-size:1rem; font-weight:700; letter-spacing:.2px;
    background: rgba(255,255,255,.06); border:1px solid var(--line);
  }
  .tick.end i{ width:3px; height:32px; background:#fff; }
  .tick.end span{ background:rgba(255,255,255,.12); border-color:rgba(255,255,255,.18); }

  /* ========== Flytande inställningsknapp ========== */
  .fab{
    position:absolute; right:16px; top:16px; width:64px; height:64px; z-index:10;
    border-radius:999px; display:grid; place-items:center;
    background: rgba(255,255,255,.06);
    color:#fff; border:1px solid var(--line-strong); font-size:22px; user-select:none;
    cursor:pointer; touch-action:manipulation;
    box-shadow: 0 8px 24px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.05);
  }
  .fab:active{ transform: scale(.98); }

  /* ========== Inställningar (glassy overlay) ========== */
  .settings{
    position:fixed; inset:0; background:rgba(6,10,20,.75);
    border:none; padding:24px; display:none; overflow:auto; z-index:9999;
  }
  .settings h2{margin:.2em 0 .6em; font-size:1.375rem; font-weight:800;}
  .settings p{ opacity:.9; }
  .card{
    max-width:980px; margin:14px auto 0; padding:18px;
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
    border:1px solid var(--line-strong); border-radius:18px;
    box-shadow: var(--glow);
  }
  .row{
    display:grid; grid-template-columns:1.2fr 1fr 1fr auto;
    gap:10px; align-items:center; margin:.5em 0;
  }
  .row input{
    padding:.9em 1rem; min-height:var(--touch); border-radius:12px;
    border:1px solid var(--line-strong);
    background: rgba(255,255,255,.08); color:#fff; font-size:1rem;
    outline:none;
  }
  .row input:focus{ box-shadow: 0 0 0 3px rgba(138,182,255,.25); border-color:#9fbefc; }

  .settings .actions{display:flex; gap:12px; margin-top:14px; flex-wrap:wrap;}
  .settings button{
    padding:.95em 1.1em; min-height:var(--touch); border-radius:12px;
    border:1px solid var(--line-strong); background:rgba(255,255,255,.08);
    color:#fff; font-weight:800; cursor:pointer; font-size:1rem;
    box-shadow: var(--glow);
  }
  .settings button:hover{ background:rgba(255,255,255,.12); }
  .settings button:active{ transform: translateY(1px); }

  .btn-accent{
    background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.06));
    border-color: rgba(255,255,255,.18);
  }

  .note{opacity:.8; font-size:.95rem; margin-top:.7rem;}

  /* ========== Rörelse (lågintensiv / respekt för äldre webviews) ========== */
  *{ transition: background .25s ease, color .25s ease, border-color .25s ease; }
  @media (prefers-reduced-motion: reduce){
    *{ transition: none !important; }
  }
</style>
</head>
<body>
  <div id="stage">
    <div class="title" id="title">Tid kvar</div>
    <div class="subtitle" id="subtitle">–</div>

    <div class="time" id="time">--</div>

    <div class="track" id="track">
      <div class="bar" id="bar"><div class="fill" id="fill"></div></div>
      <div class="ticks" id="ticks"></div>
    </div>

    <div class="fab" id="openSettings" aria-label="Inställningar">⚙︎</div>
  </div>

  <!-- Inställningar i en “card” för snyggare layout -->
  <div class="settings" id="settings" aria-modal="true" role="dialog">
    <div class="card">
      <h2>Perioder</h2>
      <p>Lägg till tidsperioder för dygnet. Timern väljer automatiskt den period som matchar klockslaget och räknar ner till periodens slut.</p>
      <div id="rows"></div>
      <div class="actions">
        <button id="add">+ Lägg till period</button>
        <button id="save" class="btn-accent">Spara</button>
        <button id="reset">Återställ standard</button>
        <button id="close">Stäng</button>
      </div>
      <p class="note" id="storageNote"></p>
    </div>
  </div>

<script>
/* ===== Selektorer ===== */
var $ = function(s){ return document.querySelector(s); };
var title=$('#title'), subtitle=$('#subtitle'), timeEl=$('#time'), fill=$('#fill'), ticks=$('#ticks');
var settings=$('#settings'), stage=$('#stage'), track=$('#track'), storageNote=$('#storageNote');

/* ===== Standardperioder ===== */
var DEFAULT_PERIODS = [
  { name:"Morgon",      start:"06:30", end:"08:00" },
  { name:"Förmiddag",   start:"08:00", end:"12:00" },
  { name:"Lunch",       start:"12:00", end:"13:00" },
  { name:"Eftermiddag", start:"13:00", end:"17:00" },
  { name:"Kväll",       start:"17:00", end:"22:15" },
  { name:"Kvällsrutin", start:"22:15", end:"22:30" },
  { name:"Natt",        start:"22:30", end:"06:30" }
];

/* ===== Lagring med minnes-fallback ===== */
var MEMORY_PERIODS = null;
function storageAvailable(){
  try{ var k='__wt_test__'; localStorage.setItem(k,'1'); localStorage.removeItem(k); return true; }
  catch(e){ return false; }
}
var HAS_STORAGE = storageAvailable();
function getRawFromStorage(){
  if (!HAS_STORAGE) return null;
  try{ return localStorage.getItem('walltimer.periods'); }catch(e){ return null; }
}
function setRawToStorage(str){
  if (!HAS_STORAGE) return false;
  try{ localStorage.setItem('walltimer.periods', str); return true; }catch(e){ return false; }
}

/* ===== Tidshjälp ===== */
function normalizeTime(v){
  if (v == null) return "00:00";
  v = String(v).trim().replace(/[.,;\-\s]+/g, ':');
  var m = v.match(/^(\d{1,2})(?::?(\d{1,2}))?/);
  var h = m && m[1] != null ? parseInt(m[1],10) : 0;
  var mi = m && m[2] != null ? parseInt(m[2],10) : 0;
  if (isNaN(h)) h = 0; if (isNaN(mi)) mi = 0;
  h = Math.max(0, Math.min(23, h)); mi = Math.max(0, Math.min(59, mi));
  return (h<10?'0':'')+h+':' + (mi<10?'0':'')+mi;
}
function t2m(t){ var n=normalizeTime(t).split(':'), h=+n[0], m=+n[1]||0; return (h%24)*60 + m; }
function nowMin(){ var n=new Date(); return n.getHours()*60+n.getMinutes()+n.getSeconds()/60; }
function pad2(x){ return (x<10?'0':'')+x; }
function fmt(ms){
  var s=Math.max(0, Math.floor(ms/1000)), h=Math.floor(s/3600); s-=h*3600;
  var m=Math.floor(s/60); s-=m*60; return h+'h '+m+'m '+pad2(s)+'s';
}

/* ===== Period-state ===== */
function sanitizeArray(arr){
  return arr.map(function(p){
    return { name: String(p.name||'Period'),
             start: normalizeTime(p.start),
             end:   normalizeTime(p.end) };
  });
}
function getPeriods(){
  if (MEMORY_PERIODS) return MEMORY_PERIODS.slice();
  var raw = getRawFromStorage();
  if (raw){
    try{
      var arr = JSON.parse(raw);
      if (Array.isArray(arr) && arr.length){
        MEMORY_PERIODS = sanitizeArray(arr);
        return MEMORY_PERIODS.slice();
      }
    }catch(e){}
  }
  MEMORY_PERIODS = sanitizeArray(DEFAULT_PERIODS);
  return MEMORY_PERIODS.slice();
}
function setPeriods(p){
  MEMORY_PERIODS = sanitizeArray(p);
  var ok = setRawToStorage(JSON.stringify(MEMORY_PERIODS));
  storageNote.textContent = ok ? "Sparat lokalt." : "Obs: Lagring låst – använder tillfällig minneslagring.";
}

/* ===== Splitta över midnatt & välj period ===== */
function expand(ps){
  var out=[];
  for(var i=0;i<ps.length;i++){
    var p=ps[i], a=t2m(p.start), b=t2m(p.end);
    if (b>=a){ out.push({ name:p.name, a:a, b:b }); }
    else{ out.push({ name:p.name, a:a, b:1440 }); out.push({ name:p.name, a:0, b:b }); }
  }
  out.sort(function(x,y){ return x.a - y.a; });
  return out;
}
/* Välj nästa period med annorlunda namn (fix för midnatt) */
function pick(ps){
  var n=nowMin(), list=expand(ps);
  var idx=-1, cur=null;
  for(var i=0;i<list.length;i++){
    var p=list[i];
    if(n>=p.a && n<p.b){ idx=i; cur=p; break; }
  }
  if(idx===-1){
    var nxtIdx = -1;
    for (var j=0;j<list.length;j++){ if (list[j].a>n){ nxtIdx=j; break; } }
    if (nxtIdx===-1) nxtIdx = 0;
    return { cur:{ name:"Paus", a:n, b:list[nxtIdx].a }, nxt:list[nxtIdx] };
  }
  var nxt=null;
  for(var k=1;k<=list.length;k++){
    var cand=list[(idx+k)%list.length];
    if (cand.name !== cur.name){ nxt=cand; break; }
  }
  if(!nxt) nxt=list[(idx+1)%list.length];
  return {cur:cur, nxt:nxt};
}

/* ===== Ticks ===== */
function chooseTickStep(totalMin){ if (totalMin <= 120) return 30; if (totalMin <= 480) return 60; return 120; }
function fmtTick(mins){ return (mins % 60 === 0) ? (mins/60)+'h' : (mins%60)+'m'; }
function drawTicks(totalMin){
  ticks.innerHTML='';
  var step = chooseTickStep(totalMin);
  for(var at=0; at<totalMin; at+=step){
    var left = (at/totalMin)*100;
    var div = document.createElement('div');
    div.className='tick'; div.style.left = left+'%';
    div.innerHTML = '<i></i><span>'+fmtTick(at)+'</span>';
    ticks.appendChild(div);
  }
  var end = document.createElement('div');
  end.className = 'tick end'; end.style.left = '100%'; end.innerHTML = '<i></i><span>slut</span>';
  ticks.appendChild(end);
}

/* ===== Ljud ===== */
var audioCtx;
function beep(ms, freq){
  ms = ms || 200; freq = freq || 880;
  try{
    audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
    var o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    o.type='sine'; o.frequency.value=freq; g.gain.value=.05; o.start();
    setTimeout(function(){ o.stop(); }, ms);
  }catch(e){}
}

/* ===== Skalning ===== */
var BASE_W = 1280, BASE_H = 800, __lastScale = 1;
function applyScale(){
  var ww=Math.max(100, window.innerWidth  || document.documentElement.clientWidth  || 0);
  var wh=Math.max(100, window.innerHeight || document.documentElement.clientHeight || 0);
  var s=Math.min(ww/BASE_W, wh/BASE_H); s=Math.max(0.1,Math.min(4,s));
  var x=(ww-BASE_W*s)/2, y=(wh-BASE_H*s)/2;
  stage.style.transform='translate('+x+'px,'+y+'px) scale('+s+')';
  __lastScale = s;
}
window.addEventListener('resize', applyScale);
window.addEventListener('orientationchange', applyScale);

/* ===== Matcha barens längd ===== */
var __trackW = 0;
function sizeTrackToTime(){
  var rect = timeEl.getBoundingClientRect();
  var wViewport = rect.width || 900;
  var wDesign = Math.max(320, Math.min(BASE_W, Math.round(wViewport / (__lastScale||1))));
  if (Math.abs(wDesign - __trackW) > 2){ track.style.width = wDesign + 'px'; __trackW = wDesign; }
}

/* ===== Loop ===== */
function pad2n(n){ return (n<10?'0':'')+n; }
function loop(){
  var ps=getPeriods();
  var picked = pick(ps);
  var cur=picked.cur, nxt=picked.nxt;
  var n = new Date();
  var nMin = n.getHours()*60 + n.getMinutes() + n.getSeconds()/60;
  var total = (cur.b - cur.a) * 60 * 1000;
  var passed = (nMin - cur.a) * 60 * 1000;
  var remain = Math.max(0, total - passed);

  var curEndMin = cur.b % 1440;
  var curEndH = pad2n(Math.floor(curEndMin/60)), curEndM = pad2n(curEndMin%60);
  var nxtStartH = pad2n(Math.floor(nxt.a/60)), nxtStartM = pad2n(nxt.a%60);

  title.textContent = 'Tid kvar av ' + cur.name + ' (slutar kl ' + curEndH + ':' + curEndM + ')';
  subtitle.textContent = 'Nästa: ' + nxt.name + ' → ' + nxtStartH + ':' + nxtStartM;

  timeEl.textContent = fmt(remain);

  var pct = total>0 ? Math.min(100, Math.max(0, (passed/total)*100)) : 100;
  fill.style.width = pct + '%';

  drawTicks((cur.b - cur.a));

  if (remain <= 10 * 60 * 1000) document.body.classList.add('danger');
  else document.body.classList.remove('danger');

  sizeTrackToTime();

  if(remain<=1000 && remain>0){
    for(var i=0;i<5;i++){ (function(k){ setTimeout(function(){ beep(120, 1000+k*60); }, k*180); })(i); }
  }

  requestAnimationFrame(loop);
}

/* ===== Inställnings-UI ===== */
function openSettings(v){ settings.style.display = (v===false)? 'none':'block'; storageNote.textContent = HAS_STORAGE ? "" : "Obs: Lagring låst – använder minneslagring."; }
function rowTpl(p,i){
  return '<div class="row" data-i="'+i+'">'+
    '<input type="text" value="'+p.name.replace(/"/g,'&quot;')+'" aria-label="Namn" placeholder="Namn (t.ex. Läggdags)" />'+
    '<input type="time" value="'+normalizeTime(p.start)+'" aria-label="Start" />'+
    '<input type="time" value="'+normalizeTime(p.end)+'" aria-label="Slut" />'+
    '<button data-del="'+i+'">Ta bort</button>'+
  '</div>';
}
function renderRows(){
  var rows=$('#rows'); var ps=getPeriods();
  var html=''; for(var i=0;i<ps.length;i++){ html+=rowTpl(ps[i],i); }
  rows.innerHTML = html;
}
function saveRows(){
  if (document.activeElement && typeof document.activeElement.blur === 'function'){
    document.activeElement.blur();
  }
  var timeInputs = settings.querySelectorAll('input[type="time"]');
  for (var i=0;i<timeInputs.length;i++){
    if (typeof timeInputs[i].blur === 'function') timeInputs[i].blur();
  }
  var rowEls=[].slice.call(document.querySelectorAll('.row'));
  var arr = rowEls.map(function(r){
    var ins=[].slice.call(r.querySelectorAll('input'));
    var name=ins[0].value;
    var start=normalizeTime(ins[1].value);
    var end  =normalizeTime(ins[2].value);
    return { name: name||'Period', start: start, end: end };
  });
  setPeriods(arr); renderRows(); openSettings(false);
}

/* Öppna via knapp */
$('#openSettings').addEventListener('click', function(){ renderRows(); openSettings(true); });

/* Långtryck öppnar – men inte om man trycker i input */
var touchTimer=null;
document.addEventListener('touchstart', function(e){
  var t=e.target && e.target.tagName;
  if (t==='INPUT' || t==='TEXTAREA') return;
  touchTimer=setTimeout(function(){ renderRows(); openSettings(true); }, 650);
}, {passive:true});
document.addEventListener('touchend', function(){
  if(touchTimer){ clearTimeout(touchTimer); touchTimer=null; }
}, {passive:true});

/* Knappar i dialogen */
$('#close').addEventListener('click', function(){ openSettings(false); });
$('#save').addEventListener('click', saveRows);
$('#add').addEventListener('click', function(){
  var ps=getPeriods(); ps.push({name:"Ny period", start:"12:00", end:"13:00"}); setPeriods(ps); renderRows();
});
$('#reset').addEventListener('click', function(){
  if (confirm('Återställ perioderna till standard? Dina egna ändringar ersätts.')) {
    setPeriods(DEFAULT_PERIODS);
    renderRows();
    openSettings(false);
  }
});
settings.addEventListener('click', function(e){
  var el=e.target; if(!el || !el.getAttribute) return;
  var idx=el.getAttribute('data-del'); if(idx==null) return;
  var ps=getPeriods(); ps.splice(+idx,1); setPeriods(ps); renderRows();
});

/* Dubbeltapp för helskärm */
document.addEventListener('dblclick', function(){
  var el=document.documentElement; if(el.requestFullscreen) el.requestFullscreen();
});

/* ===== Start ===== */
applyScale();
(function sizeTrack(){ sizeTrackToTime(); requestAnimationFrame(sizeTrack); })();
loop();
</script>
</body>
</html>
